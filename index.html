<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Convertisseur markdown / HTML</title>
        <!-- Polices -->
        <link href="https://fonts.googleapis.com/css?family=Roboto|Shadows+Into+Light" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Noto+Serif+KR|Tangerine" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" />
        <!-- Mise en forme du contenu -->
        <link id="css_link" href="css/style.css" rel="stylesheet" />
        <!-- Mise en forme des commandes et des fenêtres d'édition -->
        <link href="css/convertorStyle.css" rel="stylesheet" />

        <script type="text/javascript" src="js/marked.js"></script>
        <script type="text/javascript" src="js/cookies.js"></script>
    </head>
        
    <body>
        <!-- Boîte de dialogue pour reprendre le texte enregistré dans le cookie -->
        <div id="msg_box_wrapper">
            <div class="info_window" id="continue_old_text_window">
                <p class="converter_p">
                    Voulez-vous reprendre là où vous en étiez la dernière fois ?
                </p>
                <div class="window_btns_wrapper">
                    <button class="nice_button" id="continue_text_yes">Oui</button>
                    <button class="nice_button" id="continue_text_no">Non</button>
                </div>
            </div>
        </div>

        <!-- Commandes -->
        <div class="content_wrapper" id="commands">

            <!-- Chargement d'un fichier markdown -->
            <h3 class="converter_h3">Charger un fichier markdown (.md)</h3>
            <input type="file" id="file_input" />

            <!-- Enregistrement -->
            <h3>Enregistrer</h3>
            <div id="save_file_wrapper">
                <label for="file_name">Nom du fichier</label><br />
                <input type="text" name="file_name" id="file_name" /><br />

                <input type="radio" name="file_type" id="Markdown" value="Markdown" /><label for="Markdown">Markdown</label>
                <input type="radio" name="file_type" id="HTML" value="HTML" /><label for="HTML">HTML</label>

                <p><a href="#" id="download_link"></a></p>
            </div>

            <!-- Mise en forme -->
            <h3>Mise en forme</h3>
            <div id="css_wrapper">
                <label for="css_file">Fichier CSS à utiliser : </label>
                <input type="file" id="css_file" />
            </div>
        </div>

        <!-- Contenu markdown -->
        <div class="content_wrapper" id="content_markdown">
            <h2>Markdown</h2>
    		<form class="converter_form" id="markdown_form" method="post" action="index.html">
    			<p class="form_wrapper">
    				<textarea class="converter_textarea" id="markdown_to_convert" name="markdown_to_convert"></textarea><br />
                    <input class="nice_button" type="submit" value="Lire">
    			</p>
    		</form>
        </div>

        <!-- Contenu HTML -->
        <div class="content_wrapper" id="content_html">
            <h2>HTML</h2>
            <form class="converter_form" id="html_form" method="post" action="index.html">
                <p class="form_wrapper">
                    <textarea class="converter_textarea" id="markdown_converted" name="markdown_converted"></textarea>
                </p>
            </form>
        </div>

        <!-- Rendu final -->
        <div class="content_wrapper">
            <h2>Rendu final</h2>
            <div id="final_view"></div>
        </div>

        <!-- Conversion -->
		<script type="text/javascript">
            // Id de la zone de texte en markdown
            const MARKDOWN_TO_CONVERT_ID = 'markdown_to_convert';
            // Nom du cookie pour sauvegarder le markdown
            const MARKDOWN_COOKIE_NAME = "recording";
            // Durée de validité du cookie de sauvegarde en jours (faut pas mettre trop longtemps sinon ça déconne)
            const MARKDOWN_COOKIE_DURATION = 7;

            /**
             *  Converti le MarkDown tapé dans le formulaire en html
             */
            function convertMarkdown() {

                var contentHtmlElt = document.getElementById('markdown_converted');
                var markdownToConvertElt = document.getElementById(MARKDOWN_TO_CONVERT_ID);
                var finalViewElt = document.getElementById('final_view');
                var htmlCode = marked(markdownToConvertElt.value);
                contentHtmlElt.value = htmlCode;
                finalViewElt.innerHTML = htmlCode;
            }

            /**
             *  Sauvegarde le texte entré en markdown dans un cookie
             */
            function saveMarkdownCookie() {

                var markdownToSave = document.getElementById(MARKDOWN_TO_CONVERT_ID).value;
                setCookie(MARKDOWN_COOKIE_NAME, markdownToSave, MARKDOWN_COOKIE_DURATION);
            }

            /**
             *  Change l'action de la touche tab
             *
             *  @param {Event} evt l'évènement keyup
             */
            function changeTabAction(evt) {

                var keyCode = evt.keyCode || evt.which;
                if (keyCode == 9){
                    evt.preventDefault();
                    var s = this.selectionStart;
                    this.value = this.value.substring(0,this.selectionStart) + "\t" + this.value.substring(this.selectionEnd);
                    this.selectionEnd = s+1;
                }
            }


            // Instructions
            // ------------

            // Formulaire d'édition markdown
            var convertFormElt = document.getElementById('markdown_form');
            convertFormElt.addEventListener('submit', function(evt) {
                evt.preventDefault();
                convertMarkdown();
                saveMarkdownCookie();
            });

            // Mise à jour du contenu HTML quand on tape quelque chose dans la zone d'édition markdown
            var markdownToConvertElt = document.getElementById(MARKDOWN_TO_CONVERT_ID);
            markdownToConvertElt.addEventListener('keyup', function() {
                convertMarkdown();
                saveMarkdownCookie();
            });

            // Désactivation de la touche tab dans les zones de texte
            markdownToConvertElt.addEventListener('keydown', changeTabAction);
            document.getElementById('markdown_converted').addEventListener('keydown', changeTabAction);

            // Chargement du cookie enregistré
            if (getCookie(MARKDOWN_COOKIE_NAME)) {

                var msgBoxWrapper = document.getElementById('msg_box_wrapper');
                var msgBoxContinueCookie = document.getElementById('continue_old_text_window');
                var yesBtnElt = document.getElementById('continue_text_yes');
                var noBtnElt = document.getElementById('continue_text_no');

                msgBoxWrapper.style.display = 'flex';
                msgBoxContinueCookie.style.display = "block";
                yesBtnElt.addEventListener('click', function() {
                    markdownToConvertElt.value = getCookie(MARKDOWN_COOKIE_NAME);
                    msgBoxWrapper.style.display = 'none';
                    convertMarkdown();
                });

                noBtnElt.addEventListener('click', function() {
                    msgBoxWrapper.style.display = 'none';
                });

            } else {
                console.log('Pas de texte à charger.');
            }
        </script>
        <script type="text/javascript" src="js/fileManager.js"></script>
        <script type="text/javascript" src="js/formatContent.js"></script>
    </body>
</html>